
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PISM coding guidelines &#8212; PISM, a Parallel Ice Sheet Model 2.0.4 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Git introduction for PISM developers" href="git-introduction.html" />
    <link rel="prev" title="Submitting bug reports" href="bug-reporting.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
<div class="documentwrapper">
  <div class="bodywrapper">
    <div class="body" role="main">
      
  <div class="section" id="pism-coding-guidelines">
<h1><a class="toc-backref" href="#id1">PISM coding guidelines</a><a class="headerlink" href="#pism-coding-guidelines" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#pism-coding-guidelines" id="id1">PISM coding guidelines</a></p>
<ul>
<li><p><a class="reference internal" href="#file-names" id="id2">File names</a></p></li>
<li><p><a class="reference internal" href="#source-and-header-files" id="id3">Source and header files</a></p></li>
<li><p><a class="reference internal" href="#inline-functions-and-methods" id="id4">Inline functions and methods</a></p></li>
<li><p><a class="reference internal" href="#including-header-files" id="id5">Including header files</a></p></li>
<li><p><a class="reference internal" href="#naming" id="id6">Naming</a></p>
<ul>
<li><p><a class="reference internal" href="#variable" id="id7">Variable</a></p></li>
<li><p><a class="reference internal" href="#types-and-classes" id="id8">Types and classes</a></p></li>
<li><p><a class="reference internal" href="#functions-and-class-methods" id="id9">Functions and class methods</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#namespaces" id="id10">Namespaces</a></p>
<ul>
<li><p><a class="reference internal" href="#using-directives-and-declarations" id="id11">Using directives and declarations</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#formatting" id="id12">Formatting</a></p>
<ul>
<li><p><a class="reference internal" href="#logical-operators-should-be-surrounded-by-spaces" id="id13">Logical operators should be surrounded by spaces</a></p></li>
<li><p><a class="reference internal" href="#commas-and-semicolons-should-be-followed-by-a-space" id="id14">Commas and semicolons should be followed by a space</a></p></li>
<li><p><a class="reference internal" href="#binary-arithmetic-operators-should-be-surrounded-by-spaces" id="id15">Binary arithmetic operators should be surrounded by spaces</a></p></li>
<li><p><a class="reference internal" href="#statements" id="id16">Statements</a></p></li>
<li><p><a class="reference internal" href="#code-indentation" id="id17">Code indentation</a></p></li>
<li><p><a class="reference internal" href="#return-statements" id="id18">Return statements</a></p></li>
<li><p><a class="reference internal" href="#conditionals" id="id19">Conditionals</a></p></li>
<li><p><a class="reference internal" href="#loops" id="id20">Loops</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#error-handling" id="id21">Error handling</a></p>
<ul>
<li><p><a class="reference internal" href="#performing-an-action-every-time-a-pism-exception-is-thrown" id="id22">Performing an action every time a PISM exception is thrown</a></p></li>
<li><p><a class="reference internal" href="#calling-c-code" id="id23">Calling C code</a></p></li>
<li><p><a class="reference internal" href="#use-assert-for-sanity-checks-that-should-not-be-used-in-optimized-code" id="id24">Use assert() for sanity-checks that should not be used in optimized code</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#function-design" id="id25">Function design</a></p>
<ul>
<li><p><a class="reference internal" href="#function-arguments-constness" id="id26">Function arguments; constness</a></p></li>
<li><p><a class="reference internal" href="#method-versus-a-function" id="id27">Method versus a function</a></p></li>
<li><p><a class="reference internal" href="#virtual-methods" id="id28">Virtual methods</a></p></li>
<li><p><a class="reference internal" href="#private-versus-protected-versus-public" id="id29">private versus protected versus public</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="file-names">
<h2><a class="toc-backref" href="#id2">File names</a><a class="headerlink" href="#file-names" title="Permalink to this headline">¶</a></h2>
<p>C++ source files use the extension <code class="docutils literal notranslate"><span class="pre">.cc</span></code>. Headers use <code class="docutils literal notranslate"><span class="pre">.hh</span></code>. C code uses <code class="docutils literal notranslate"><span class="pre">.c</span></code> and <code class="docutils literal notranslate"><span class="pre">.h</span></code>.</p>
<p>The <em>basename</em> of a file containing the source code for a class should match the name of
this class, including capitalization. For example, a class <code class="docutils literal notranslate"><span class="pre">Foo</span></code> is declared in <code class="docutils literal notranslate"><span class="pre">Foo.hh</span></code>
and implemented in <code class="docutils literal notranslate"><span class="pre">Foo.cc</span></code>.</p>
</div>
<div class="section" id="source-and-header-files">
<h2><a class="toc-backref" href="#id3">Source and header files</a><a class="headerlink" href="#source-and-header-files" title="Permalink to this headline">¶</a></h2>
<p>Each header file must have an include guard. Do <em>not</em> use “randomized” names of include
guards.</p>
<p>Headers should <em>not</em> contain function and class method implementations unless these
implementations <em>should be inlined</em>; see below.</p>
</div>
<div class="section" id="inline-functions-and-methods">
<h2><a class="toc-backref" href="#id4">Inline functions and methods</a><a class="headerlink" href="#inline-functions-and-methods" title="Permalink to this headline">¶</a></h2>
<p>Implementations of inline methods should be <em>outside</em> of class declarations and in a
<em>separate header</em> called <code class="docutils literal notranslate"><span class="pre">Foo_inline.hh</span></code>. This header will then be included from <code class="docutils literal notranslate"><span class="pre">Foo.hh</span></code>.</p>
</div>
<div class="section" id="including-header-files">
<h2><a class="toc-backref" href="#id5">Including header files</a><a class="headerlink" href="#including-header-files" title="Permalink to this headline">¶</a></h2>
<p>Include all system headers before PISM headers. Separate system headers from PISM headers
with an empty line.</p>
<p>Good:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;IceGrid.hh&quot;</span><span class="cp"></span>
</pre></div>
</div>
<p>Bad:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;IceGrid.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>Whenever appropriate add comments explaining why a particular header was included.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="c1"> // strcmp</span><span class="cp"></span>
</pre></div>
</div>
</div>
<div class="section" id="naming">
<h2><a class="toc-backref" href="#id6">Naming</a><a class="headerlink" href="#naming" title="Permalink to this headline">¶</a></h2>
<div class="section" id="variable">
<h3><a class="toc-backref" href="#id7">Variable</a><a class="headerlink" href="#variable" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Variable names should use lower case letters and (if necessary) digits separated by
underscores, for example: <code class="docutils literal notranslate"><span class="pre">ice_thickness</span></code>.</p></li>
<li><p>Do not abbreviate names of variables used in more than one scope <strong>unless</strong> this is
needed to keep the name under 30 characters. If a function uses a variable so many times
typing a long name is a hassle, create a reference with a shorter name that is only
visible in this scope. (This alias will be compiled away.)</p></li>
<li><p>Single-letter variable names should only be used in “small” scopes (short functions,
etc.)</p></li>
<li><p>If you are going to use a single-letter name, pick a letter that is easy to read (avoid
<code class="docutils literal notranslate"><span class="pre">i</span></code>, <code class="docutils literal notranslate"><span class="pre">l</span></code>, and <code class="docutils literal notranslate"><span class="pre">o</span></code>).</p></li>
<li><p>Names of class data members should use the <code class="docutils literal notranslate"><span class="pre">m_</span></code> prefix, for example: <code class="docutils literal notranslate"><span class="pre">m_name</span></code>.</p></li>
<li><p>Names of static data members should use the <code class="docutils literal notranslate"><span class="pre">sm_</span></code> prefix.</p></li>
<li><p>Global variables (which should be avoided in general) use the <code class="docutils literal notranslate"><span class="pre">g</span></code> prefix.</p></li>
</ul>
</div>
<div class="section" id="types-and-classes">
<h3><a class="toc-backref" href="#id8">Types and classes</a><a class="headerlink" href="#types-and-classes" title="Permalink to this headline">¶</a></h3>
<p>Names of types and classes use <code class="docutils literal notranslate"><span class="pre">CamelCase</span></code>.</p>
</div>
<div class="section" id="functions-and-class-methods">
<h3><a class="toc-backref" href="#id9">Functions and class methods</a><a class="headerlink" href="#functions-and-class-methods" title="Permalink to this headline">¶</a></h3>
<p>Names of functions and class methods use the same rules are variable names, with some
additions.</p>
<ul class="simple">
<li><p>If a method is used to get a property of an object that cannot be reset (example:
<code class="docutils literal notranslate"><span class="pre">IceGrid::Mx()</span></code>), omit <code class="docutils literal notranslate"><span class="pre">get_</span></code> from the name.</p></li>
<li><p>If a getter method has a corresponding setter method, their names should be
<em>predictable</em>: <code class="docutils literal notranslate"><span class="pre">Foo::get_bar()</span></code> and <code class="docutils literal notranslate"><span class="pre">Foo::set_bar()</span></code>. In this case, <em>do not</em> omit <code class="docutils literal notranslate"><span class="pre">get_</span></code>
from the name of the getter.</p></li>
</ul>
</div>
</div>
<div class="section" id="namespaces">
<h2><a class="toc-backref" href="#id10">Namespaces</a><a class="headerlink" href="#namespaces" title="Permalink to this headline">¶</a></h2>
<p>Everything in PISM goes into the <code class="docutils literal notranslate"><span class="pre">pism</span></code> namespace. See the source code browser for more
namespaces (roughly one per sub-system).</p>
<p>Notable namespaces include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">atmosphere</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bed</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calving</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">energy</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">frontalmelt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hydrology</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ocean</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rheology</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sea_level</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stressbalance</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">surface</span></code></p></li>
</ul>
<div class="section" id="using-directives-and-declarations">
<h3><a class="toc-backref" href="#id11">Using directives and declarations</a><a class="headerlink" href="#using-directives-and-declarations" title="Permalink to this headline">¶</a></h3>
<p>Do <em>not</em> import all names from a namespace with <code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">namespace</span> <span class="pre">foo;</span></code></p>
<p>Do import <em>specific</em> names with <code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">::foo::bar;</span></code> in <code class="docutils literal notranslate"><span class="pre">.cc</span></code> files.</p>
</div>
</div>
<div class="section" id="formatting">
<h2><a class="toc-backref" href="#id12">Formatting</a><a class="headerlink" href="#formatting" title="Permalink to this headline">¶</a></h2>
<p>PISM includes a <code class="docutils literal notranslate"><span class="pre">.clang-format</span></code> file that makes it easy to re-format source to make it
conform to these guidelines.</p>
<p>To re-format a file, commit it to the repository, then run</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>clang-format -i filename.cc
</pre></div>
</div>
<p>(Here <code class="docutils literal notranslate"><span class="pre">-i</span></code> tells clang-format to edit files “in place.” Note that editing in place is
safe because you added it to the repository.)</p>
<div class="section" id="logical-operators-should-be-surrounded-by-spaces">
<h3><a class="toc-backref" href="#id13">Logical operators should be surrounded by spaces</a><a class="headerlink" href="#logical-operators-should-be-surrounded-by-spaces" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Good</span>
<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">action</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Bad</span>
<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">==</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">action</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="commas-and-semicolons-should-be-followed-by-a-space">
<h3><a class="toc-backref" href="#id14">Commas and semicolons should be followed by a space</a><a class="headerlink" href="#commas-and-semicolons-should-be-followed-by-a-space" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Good</span>
<span class="n">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

<span class="c1">// Bad</span>
<span class="n">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
<span class="n">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="p">,</span><span class="n">c</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="binary-arithmetic-operators-should-be-surrounded-by-spaces">
<h3><a class="toc-backref" href="#id15">Binary arithmetic operators should be surrounded by spaces</a><a class="headerlink" href="#binary-arithmetic-operators-should-be-surrounded-by-spaces" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Good</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">w</span><span class="p">);</span>

<span class="c1">// Bad</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">/</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">w</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="statements">
<h3><a class="toc-backref" href="#id16">Statements</a><a class="headerlink" href="#statements" title="Permalink to this headline">¶</a></h3>
<p>One statement per line.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Good</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">// Bad</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="code-indentation">
<h3><a class="toc-backref" href="#id17">Code indentation</a><a class="headerlink" href="#code-indentation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Use two spaces per indentation level.</p></li>
<li><p>Do not use tabs.</p></li>
<li><p>Opening braces go with the keyword (“One True Brace Style”).</p></li>
</ul>
<p>Examples:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">64</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(...)</span> <span class="p">{</span>
  <span class="n">something</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Object</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Object</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="return-statements">
<h3><a class="toc-backref" href="#id18">Return statements</a><a class="headerlink" href="#return-statements" title="Permalink to this headline">¶</a></h3>
<p>Return statements should appear on a line of their own.</p>
<p>Do not surround the return value with parenthesis if you don’t have to.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Good</span>
<span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">int</span> <span class="n">argument</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argument</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">64</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Bad</span>
<span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">int</span> <span class="n">argument</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argument</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="conditionals">
<h3><a class="toc-backref" href="#id19">Conditionals</a><a class="headerlink" href="#conditionals" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>one space between <code class="docutils literal notranslate"><span class="pre">if</span></code> and the opening parenthesis</p></li>
<li><p>no spaces between <code class="docutils literal notranslate"><span class="pre">(</span></code> and the condition (<code class="docutils literal notranslate"><span class="pre">(condition)</span></code>, not <code class="docutils literal notranslate"><span class="pre">(</span> <span class="pre">condition</span> <span class="pre">)</span></code>)</p></li>
<li><p>all <code class="docutils literal notranslate"><span class="pre">if</span></code> blocks should use braces (<code class="docutils literal notranslate"><span class="pre">{</span></code> and <code class="docutils literal notranslate"><span class="pre">}</span></code>) <em>unless</em> it makes the code significantly
harder to read</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(condition)</span></code> should always be on its own line</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">else</span></code> should be on the same line as the closing parenthesis: <code class="docutils literal notranslate"><span class="pre">}</span> <span class="pre">else</span> <span class="pre">{</span> <span class="pre">...</span></code></p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Good</span>
<span class="k">if</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">action</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Bad</span>
<span class="k">if</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="n">action</span><span class="p">();</span>

<span class="c1">// Sometimes acceptable:</span>
<span class="k">if</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span>
  <span class="n">action</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="loops">
<h3><a class="toc-backref" href="#id20">Loops</a><a class="headerlink" href="#loops" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">for</span></code>, <code class="docutils literal notranslate"><span class="pre">while</span></code>, <code class="docutils literal notranslate"><span class="pre">do</span> <span class="pre">{...}</span> <span class="pre">unless</span></code> loops are formatted similarly to conditional blocks.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">action</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">while</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">action</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">do</span> <span class="p">{</span>
  <span class="n">action</span><span class="p">();</span>
<span class="p">}</span> <span class="n">unless</span> <span class="p">(</span><span class="n">condition</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="error-handling">
<h2><a class="toc-backref" href="#id21">Error handling</a><a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>First of all, PISM is written in C++, so unless we use a non-throwing <code class="docutils literal notranslate"><span class="pre">new</span></code> and completely
avoid STL, exceptions are something we have to live with. This means that we more or less
have to use exceptions to handle errors in PISM. (Mixing two error handling styles is a
<em>bad</em> idea.)</p>
<p>So, throw an exception to signal an error; PISM has a generic runtime error exception
class <code class="docutils literal notranslate"><span class="pre">pism::RuntimeError</span></code>.</p>
<p>To throw an exception with an informative message, use</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">throw</span> <span class="n">RuntimeError</span><span class="o">::</span><span class="n">formatted</span><span class="p">(</span><span class="n">PISM_ERROR_LOCATION</span><span class="p">,</span>
                              <span class="s">&quot;format string %s&quot;</span><span class="p">,</span> <span class="s">&quot;data&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Error handling in a parallel program is hard. If all ranks in a communicator throw an
exception, that’s fine. If some do and some don’t PISM will hang as soon as one rank
performs a locking MPI call. I don’t think we can prevent this in general, but we can
handle some cases.</p>
<p>Use</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">ParallelSection</span> <span class="nf">rank0</span><span class="p">(</span><span class="n">communicator</span><span class="p">);</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// something that may throw</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(...)</span> <span class="p">{</span>
  <span class="n">rank0</span><span class="p">.</span><span class="n">failed</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">rank0</span><span class="p">.</span><span class="n">check</span><span class="p">();</span>
</pre></div>
</div>
<p>to wrap code that is likely to fail on some (but not all) ranks. <code class="docutils literal notranslate"><span class="pre">rank0.failed()</span></code> prints
an error message from the rank that failed and <code class="docutils literal notranslate"><span class="pre">rank0.check()</span></code> calls <code class="docutils literal notranslate"><span class="pre">MPI_Allreduce(...)</span></code>
to tell other ranks in a communicator that everybody needs to throw an exception.
(<code class="docutils literal notranslate"><span class="pre">pism::ParallelSection::failed()</span></code> should be called in a <code class="docutils literal notranslate"><span class="pre">catch</span> <span class="pre">(...)</span> <span class="pre">{...}</span></code> block
<strong>only</strong>.)</p>
<p>In general one should not use <code class="docutils literal notranslate"><span class="pre">catch</span> <span class="pre">(...)</span></code>. It <em>should</em> be used in these three cases,
though:</p>
<ol class="arabic simple">
<li><p>With <code class="docutils literal notranslate"><span class="pre">pism::ParallelSection</span></code> (see above).</p></li>
<li><p>In callback functions passed to C libraries. (A callback is not allowed to throw, so we
have to catch everything.)</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">main()</span></code> to catch all exceptions before terminating.</p></li>
</ol>
<div class="section" id="performing-an-action-every-time-a-pism-exception-is-thrown">
<h3><a class="toc-backref" href="#id22">Performing an action every time a PISM exception is thrown</a><a class="headerlink" href="#performing-an-action-every-time-a-pism-exception-is-thrown" title="Permalink to this headline">¶</a></h3>
<p>The class <code class="docutils literal notranslate"><span class="pre">pism::RuntimeError</span></code> allows setting a “hook” that is called by the constructor
of <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>. See the example below for a way to use it.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;error_handling.hh&quot;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">hook</span><span class="p">(</span><span class="n">pism</span><span class="o">::</span><span class="n">RuntimeError</span> <span class="o">*</span><span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;throwing exception </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exception</span><span class="o">-&gt;</span><span class="n">what</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

  <span class="n">pism</span><span class="o">::</span><span class="n">RuntimeError</span><span class="o">::</span><span class="n">set_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">pism</span><span class="o">::</span><span class="n">RuntimeError</span><span class="p">(</span><span class="s">&quot;oh no!&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">pism</span><span class="o">::</span><span class="n">RuntimeError</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;caught an exception </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">MPI_Finalize</span><span class="p">();</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="calling-c-code">
<h3><a class="toc-backref" href="#id23">Calling C code</a><a class="headerlink" href="#calling-c-code" title="Permalink to this headline">¶</a></h3>
<p>Check the return code of every C call and convert it to an exception if needed. Use macros
<code class="docutils literal notranslate"><span class="pre">PISM_CHK</span></code> and <code class="docutils literal notranslate"><span class="pre">PISM_C_CHK</span></code> for this.</p>
<p>When calling several C function in sequence, it may make sense to wrap them in a function.
Then we can check its return value and throw an exception if necessary.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">call_petsc</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Multiple PETSc calls here, followed by CHKERRQ(ierr).</span>
  <span class="c1">// This way we need to convert *one* return code into an exception, not many.</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// elsewhere:</span>
<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">call_petsc</span><span class="p">();</span> <span class="n">PISM_C_CHK</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;call_petsc&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="use-assert-for-sanity-checks-that-should-not-be-used-in-optimized-code">
<h3><a class="toc-backref" href="#id24">Use assert() for sanity-checks that should not be used in optimized code</a><a class="headerlink" href="#use-assert-for-sanity-checks-that-should-not-be-used-in-optimized-code" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">assert</span></code> macro should be used to check pre-conditions and post-conditions that can
fail <em>due to programming errors</em>.</p>
<p><strong>Do not</strong> use <code class="docutils literal notranslate"><span class="pre">assert</span></code> to validate user input.</p>
<p>Note that <em>user input includes function arguments</em> for all functions and public members of
classes accessible using Python wrappers. (Use exceptions instead.)</p>
</div>
</div>
<div class="section" id="function-design">
<h2><a class="toc-backref" href="#id25">Function design</a><a class="headerlink" href="#function-design" title="Permalink to this headline">¶</a></h2>
<p>Functions are the way to <em>manage complexity</em>. They are not just for code reuse: the main
benefit of creating a function is that a self-contained piece of code is easier both to
<strong>understand</strong> and <strong>test</strong>.</p>
<p>Functions should not have side effects (if at all possible). In particular, do not use and
especially do not <em>modify</em> “global” objects. If a function needs to modify an existing
field “in place”, pass a reference to that field as an argument and document this argument
as an “input” or an “input/output” argument.</p>
<div class="section" id="function-arguments-constness">
<h3><a class="toc-backref" href="#id26">Function arguments; constness</a><a class="headerlink" href="#function-arguments-constness" title="Permalink to this headline">¶</a></h3>
<p>Pass C++ class instances by const reference <em>unless</em> an instance is modified in place.
This makes it easier to recognize <em>input</em> (read-only) and <em>output</em> arguments.</p>
<p>Do <strong>not</strong> use <code class="docutils literal notranslate"><span class="pre">const</span></code> when passing C types: <code class="docutils literal notranslate"><span class="pre">f()</span></code> and <code class="docutils literal notranslate"><span class="pre">g()</span></code> below are equivalent.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span> <span class="nf">f</span><span class="p">(</span><span class="k">const</span> <span class="kt">double</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="nf">g</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="method-versus-a-function">
<h3><a class="toc-backref" href="#id27">Method versus a function</a><a class="headerlink" href="#method-versus-a-function" title="Permalink to this headline">¶</a></h3>
<p>Do <strong>not</strong> implement something as a class method if the same functionality can be
implemented as a standalone function. Turn a class method into a standalone function if
you notice that it uses the <em>public</em> class interface only.</p>
</div>
<div class="section" id="virtual-methods">
<h3><a class="toc-backref" href="#id28">Virtual methods</a><a class="headerlink" href="#virtual-methods" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Do not make a method virtual unless you have to.</p></li>
<li><p>Public methods should not be virtual (create “non-virtual interfaces”)</p></li>
<li><p><strong>Never</strong> add <code class="docutils literal notranslate"><span class="pre">__attribute__((noreturn))</span></code> to a virtual class method.</p></li>
</ul>
</div>
<div class="section" id="private-versus-protected-versus-public">
<h3><a class="toc-backref" href="#id29">private versus protected versus public</a><a class="headerlink" href="#private-versus-protected-versus-public" title="Permalink to this headline">¶</a></h3>
<p>Most data members and class methods should be <code class="docutils literal notranslate"><span class="pre">private</span></code>.</p>
<p>Make it <code class="docutils literal notranslate"><span class="pre">protected</span></code> if it should be accessible from a derived class.</p>
<p>Make it <code class="docutils literal notranslate"><span class="pre">public</span></code> only if it is a part of the interface.</p>
</div>
</div>
</div>


      <hr>
      <table style="width: 100%">
        <tr>
          <td style="text-align: left; width: 30%">
              <a class="reference internal" href="bug-reporting.html">Previous</a>
          </td>
          <td style="text-align: center; width: 30%">
              <a class="reference internal" href="index.html">Up</a>
          </td>
          <td style="text-align: right; width: 30%">
              <a class="reference internal" href="git-introduction.html">Next</a>
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/pism-logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installing PISM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manual/index.html">PISM User’s Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../climate_forcing/index.html">Climate forcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../technical/index.html">Technical notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Contributing to PISM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="bug-reporting.html">Submitting bug reports</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">PISM coding guidelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#file-names">File names</a></li>
<li class="toctree-l3"><a class="reference internal" href="#source-and-header-files">Source and header files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inline-functions-and-methods">Inline functions and methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#including-header-files">Including header files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#naming">Naming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#namespaces">Namespaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="#formatting">Formatting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-handling">Error handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#function-design">Function design</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="git-introduction.html">Git introduction for PISM developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="git-branches.html">Git branches</a></li>
<li class="toctree-l2"><a class="reference internal" href="development-workflow.html">Development workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-to.html">How do I…?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../authorship.html">Authorship</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zzz_references_html.html">References</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      Git revision v2.0.3-16-gad24975a0
      committed by Constantine Khrulev
      on 2022-05-25 10:48:10 -0800 |
      &copy; 2004--2022, the PISM authors.
      
    </div>
  </body>
</html>